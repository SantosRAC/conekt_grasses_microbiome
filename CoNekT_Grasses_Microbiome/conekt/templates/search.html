{% extends 'base.html' %}

{% block title %}Search{% endblock %}

{% block container %}
    <div class="container">
        <h1>Search Page</h1>
        <form method="POST" action="{{ url_for('search.search') }}">
            {{ form.csrf_token }}
            <div class="row">
                <!-- Campo de busca para Taxonomy -->
                <div class="form-group col-md-3">
                    {{ form.taxonomy.label }}
                    {{ form.taxonomy(class_="form-control", id="taxonomyInput", autocomplete="off") }}
                </div>

                <div class="form-group col-md-3">
                    {{ form.country.label }}
                    {{ form.country(class_="form-control", id="countryInput", autocomplete="off") }}
                </div>

                <div class="form-group col-md-3">
                    {{ form.envo_class.label }}
                    {{ form.envo_class(class_="form-control") }}
                </div>

                <div class="form-group col-md-3">
                    {{ form.envo_annotation.label }}
                    {{ form.envo_annotation(class_="form-control") }}
                </div>

            </div>
            <br>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>

        <hr>

        <h2>Search Results</h2>

        {% if message %}
            <div class="alert alert-info">
                {{ message }}
            </div>
        {% endif %}

        {% if results %}
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-striped table-hover">
                    <thead class="sticky-top bg-light">
                        <tr>
                            <th>Genome ID</th>
                            <th>Type</th>
                            <th>Domain</th>
                            <th>Phylum</th>
                            <th>Class</th>
                            <th>Order</th>
                            <th>Family</th>
                            <th>Genus</th>
                            <th>Species</th>
                            <th>Quality</th>
                            <th>Country</th>
                            <th>Local</th>
                            <th>ENVO Class</th>
                            <th>ENVO Annotation</th>
                            <th>DOI</th>
                            <th>NCBI Accession</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                            <tr>
                                <td>{{ result.genome_id }}</td>
                                <td>{{ result.genome_type }}</td>
                                <td>{{ result.domain or 'N/A' }}</td>
                                <td>{{ result.phylum or 'N/A' }}</td>
                                <td>{{ result.Class or 'N/A' }}</td>
                                <td>{{ result.order or 'N/A' }}</td>
                                <td>{{ result.family or 'N/A' }}</td>
                                <td>{{ result.genus or 'N/A' }}</td>
                                <td>
                                    {% if result.cluster_id %}
                                        <a href="{{ url_for('taxonomy_explorer.show_genomes', cluster_id=result.cluster_id) }}">
                                            {{ result.species or 'N/A' }}
                                        </a>
                                    {% else %}
                                        {{ result.species or 'N/A' }}
                                    {% endif %}
                                </td>
                                <td>{{ result.quality or 'N/A' }}</td>
                                <td>{{ result.country or 'N/A' }}</td>
                                <td>{{ result.local or 'N/A' }}</td>
                                <td>{{ result.envo_class or 'N/A' }}</td>
                                <td>{{ result.envo_annotation or 'N/A' }}</td>
                                <td>
                                    {% if result.doi %}
                                        <a href="https://{{ result.doi }}" target="_blank">{{ result.doi }}</a>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.ncbi_accession %}
                                        <a href="https://www.ncbi.nlm.nih.gov/datasets/genome/{{ result.ncbi_accession }}" target="_blank">
                                            {{ result.ncbi_accession }}
                                        </a>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No results found.</p>
        {% endif %}
    </div>

    <style>
        .table-responsive {
            position: relative;
        }
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .table th {
            white-space: nowrap;
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
        }
        .table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .table td:hover {
            overflow: visible;
            white-space: normal;
            word-break: break-word;
        }
    </style>
{% endblock %}

{% block extrajs %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<script>
    // Função para carregar as opções de Taxonomy no campo de busca
    async function setupTaxonomyAutocomplete() {
        try {
            const response = await fetch('{{ url_for("search.get_taxonomy_options") }}');
            if (!response.ok) {
                console.error('Network response was not ok', response.status);
                return;
            }

            const taxonomyOptions = await response.json();
            const allOptions = new Set();
            
            // Combine all taxonomic levels into a single list
            Object.values(taxonomyOptions).forEach(level => {
                level.forEach(option => allOptions.add(option));
            });

            // Setup jQuery UI autocomplete
            $('#taxonomyInput').autocomplete({
                source: Array.from(allOptions),
                minLength: 2,
                delay: 300
            });
        } catch (error) {
            console.error('Error loading taxonomy options:', error);
        }
    }

    // Função para carregar as opções de Country no campo de busca
    async function setupCountryAutocomplete() {
        try {
            const response = await fetch('{{ url_for("search.get_country") }}');
            if (!response.ok) {
                console.error('Network response was not ok', response.status);
                return;
            }

            const countries = await response.json();

            // Setup jQuery UI autocomplete
            $('#countryInput').autocomplete({
                source: countries,
                minLength: 2,
                delay: 300
            });
        } catch (error) {
            console.error('Error loading countries:', error);
        }
    }

    // Função para carregar as opções de ENVO Class no campo de busca
    async function loadEnvoClasses() {
        try {
            const response = await fetch('{{ url_for("search.get_envo_classes") }}');
            const envoClasses = await response.json();
            const dataList = document.getElementById('envoClassList');

            envoClasses.forEach(function(item) {
                const option = document.createElement('option');
                option.value = item;
                dataList.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading ENVO classes:', error);
        }
    }

    // Função para carregar as opções de ENVO Annotation no campo de busca
    async function loadEnvoAnnotations() {
        try {
            const response = await fetch('{{ url_for("search.get_envo_annotations") }}');
            const envoAnnotations = await response.json();
            const dataList = document.getElementById('envoAnnotationList');

            envoAnnotations.forEach(function(item) {
                const option = document.createElement('option');
                option.value = item;
                dataList.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading ENVO annotations:', error);
        }
    }

    // Chamar as funções para carregar as opções quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        setupTaxonomyAutocomplete();
        setupCountryAutocomplete();
        loadEnvoClasses();
        loadEnvoAnnotations();
    });
</script>
{% endblock %}
